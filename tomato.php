<?

$config['start_day'] = "20131017000000";

$tasks_new = array(
    array("cost"=>8, "real"=>8, "name_chn"=>"--  2014项目会议", "deadline"=>null),
    array("cost"=>2, "real"=>2, "name_chn"=>"--  自检故障修复", "deadline"=>null),
    array("cost"=>8, "real"=>8, "name_chn"=>"--  故障维修录入系统", "deadline"=>null),
    array("cost"=>8, "real"=>8, "name_chn"=>"--  esg更换返修记录系统", "deadline"=>null),
    array("cost"=>8, "real"=>12,"name_chn"=>"-- 【运维】设置联合基站过滤器", "deadline"=>null),
    array("cost"=>4, "real"=>4, "name_chn"=>"【运维】有其他交流设备的参数 手动总能耗检测", "deadline"=>null),
    array("cost"=>12,"real"=>12,"name_chn"=>"【运维】空调不制冷实时故障（结算用）", "deadline"=>null),
    array("cost"=>8, "real"=>8, "name_chn"=>"老化系统设计开发", "deadline"=>null),
    array("cost"=>8, "real"=>8, "name_chn"=>"前端项目页面设计", "deadline"=>null),
    array("cost"=>8, "real"=>8, "name_chn"=>"前端城市页面设计", "deadline"=>null),
    array("cost"=>8, "real"=>8, "name_chn"=>"前端单站页面设计", "deadline"=>null),
    array("cost"=>6, "real"=>6, "name_chn"=>"分割产生脏数据处理", "deadline"=>null)
);

$tasks_old = array(
    array("cost"=>5, "real"=>5, "name_chn"=>"--  给出“分库分表”的详细且可执行的开发和执行过程","deadline"=>null),
    array("cost"=>5, "real"=>5, "name_chn"=>"--  前端小改版并给出前端大改变计划", "deadline"=>null),
    array("cost"=>5, "real"=>5, "name_chn"=>"--  系统问题修正 （redmine issue #728 #713 #674 #636 #484）", "deadline"=>null),
    array("cost"=>6, "real"=>6, "name_chn"=>"--  【运维】 两站对比功能完成", "deadline"=>"20131022000000"),
    array("cost"=>2, "real"=>2, "name_chn"=>"--  番茄自动列表程序开发", "deadline"=>null),
    array("cost"=>8, "real"=>6, "name_chn"=>"--  合同批次的开发和数据维护，报表输出部分改写完成 ", "deadline"=>null),
    array("cost"=>1, "real"=>1, "name_chn"=>"--  解决esg 485 重启bug", "deadline"=>null),
    array("cost"=>7, "real"=>6, "name_chn"=>"--  【运维】 智能电表某故障分析完成", "deadline"=>"20131025000000"),
    array("cost"=>1, "real"=>1, "name_chn"=>"--  添加后台导出的rom版本列", "deadline"=>null),
    array("cost"=>5, "real"=>5, "name_chn"=>"--  统计模块框架，初步生成统计合同批次统计框架", "deadline"=>null),
    array("cost"=>3, "real"=>3, "name_chn"=>"--  【运维】 基站增加拆除站点",     "deadline"=>null),
    array("cost"=>3, "real"=>3, "name_chn"=>"--  合同批次相关基站统计", "deadline"=>null),
    array("cost"=>1, "real"=>1, "name_chn"=>"--  【运维】 恒温柜用上另外两个传感器", "deadline"=>null),
    array("cost"=>2, "real"=>2, "name_chn"=>"--  合同结算时间统计,广西南宁数据导出", "deadline"=>null),
    array("cost"=>3, "real"=>3, "name_chn"=>"--  【运维】 故障，报表需要改变等部分, 需要排除已经拆了的站", "deadline"=>"20131029000000"),
    array("cost"=>2, "real"=>2, "name_chn"=>"--  服务器托管到机房 网络配置完毕", "deadline"=>null),
    array("cost"=>4, "real"=>4, "name_chn"=>"--  （系统统计）初步完成", "deadline"=>null),
    array("cost"=>6, "real"=>6, "name_chn"=>"--  能耗统计初步 完成", "deadline"=>null),
    array("cost"=>2, "real"=>2, "name_chn"=>"--  【运维】 加入失去连接LGNexus 4的参数 失去连接前室内温度 rom_version接口", "deadline"=>"20131031000000"),
    array("cost"=>4, "real"=>4, "name_chn"=>"--  【运维】 批量设置功能完善", "deadline"=>"20131101000000"),
    array("cost"=>1, "real"=>1, "name_chn"=>"--  【运维】 零点清空电表故障2", "deadline"=>null),
    array("cost"=>7, "real"=>7, "name_chn"=>"--  命令模块重构 加入6种状态", "deadline"=>null),
    array("cost"=>1, "real"=>1, "name_chn"=>"--  思考手动系统测试的部署方式", "deadline"=>null),
    array("cost"=>5, "real"=>5, "name_chn"=>"--  接入项目添加简单的老化流程", "deadline"=>null),
    array("cost"=>2, "real"=>2, "name_chn"=>"--  开发软esg 用于批量测试分库结果", "deadline"=>null),
    array("cost"=>8, "real"=>8, "name_chn"=>"--  加分表索引完成", "deadline"=>null),
    array("cost"=>4, "real"=>4, "name_chn"=>"--  为分表重构后端完成", "deadline"=>null),
    array("cost"=>3, "real"=>3, "name_chn"=>"--  后端-简易数据分布图", "deadline"=>null),
    array("cost"=>3, "real"=>3, "name_chn"=>"--  【运维】断线前的BUG 智能电表3bug", "deadline"=>"20131107000000"),
    array("cost"=>2, "real"=>3, "name_chn"=>"--  胡总关于统计系统的改进意见", "deadline"=>"20131107000000"),
    array("cost"=>5, "real"=>5, "name_chn"=>"--  服务器数据表修复", "deadline"=>null),
    array("cost"=>3, "real"=>5, "name_chn"=>"--  分表重构daydatas monthdatas", "deadline"=>null),
    array("cost"=>7, "real"=>8, "name_chn"=>"--  为分表重构fixdata等完成", "deadline"=>null),
    array("cost"=>7, "real"=>10,"name_chn"=>"--  为分表重构bug完成", "deadline"=>null),
    array("cost"=>7, "real"=>7, "name_chn"=>"--  为分表重构前端完成", "deadline"=>null),
    array("cost"=>6, "real"=>6, "name_chn"=>"--  为分表重构interface getLast接口", "deadline"=>null),
    array("cost"=>6, "real"=>6, "name_chn"=>"--  正式分割新表完成", "deadline"=>null),
    array("cost"=>3, "real"=>5, "name_chn"=>"--  接入系统 安装基站界面", "deadline"=>null),
    array("cost"=>6, "real"=>5, "name_chn"=>"--  分析给出老数据处理方案", "deadline"=>null),
    array("cost"=>6, "real"=>6, "name_chn"=>"--  统计任选个月份节能数据", "deadline"=>null),
    array("cost"=>4, "real"=>4, "name_chn"=>"--  接入系统建站自动发命令", "deadline"=>null),
    array("cost"=>5, "real"=>4, "name_chn"=>"--  接入系统的老化系统", "deadline"=>null),
    array("cost"=>5, "real"=>5, "name_chn"=>"--  【运维】广西每日节能显示", "deadline"=>null),
    array("cost"=>12,"real"=>12,"name_chn"=>"--  【运维】空调是否受控故障开发", "deadline"=>null),
    array("cost"=>4, "real"=>4, "name_chn"=>"--  接入系统 升级，建站完善", "deadline"=>null),
    array("cost"=>6, "real"=>6, "name_chn"=>"--  接入系统前端", "deadline"=>null),
    array("cost"=>6, "real"=>8, "name_chn"=>"--  接入系统esg和主项目同步", "deadline"=>null),
    array("cost"=>2, "real"=>2, "name_chn"=>"--  胡刚无合同基站计算", "deadline"=>null),
    array("cost"=>6, "real"=>6, "name_chn"=>"--  前端开发详细规划", "deadline"=>null),
    array("cost"=>2, "real"=>2, "name_chn"=>"--  【运维】0.1安培问题", "deadline"=>null),
    array("cost"=>2, "real"=>2, "name_chn"=>"--  【运维】只要空调不受控，就不要有其他交流设备 #788", "deadline"=>null),
    array("cost"=>6, "real"=>6, "name_chn"=>"--  接入系统rom在装站点时升级", "deadline"=>null),
    array("cost"=>4, "real"=>4, "name_chn"=>"--  【运维】基站运营状态完善 #788", "deadline"=>null),
    array("cost"=>12,"real"=>12,"name_chn"=>"--  前端开发框架搭建", "deadline"=>null),
    array("cost"=>3, "real"=>3, "name_chn"=>"--  【运维】加入新风类型", "deadline"=>null),
    array("cost"=>4, "real"=>4, "name_chn"=>"--  【运维】智能电表故障平冤假错案", "deadline"=>null),
    array("cost"=>14,"real"=>14,"name_chn"=>"--  【运维】江苏联通项目任意天节能报表", "deadline"=>null),
    array("cost"=>14,"real"=>14,"name_chn"=>"--  【运维】广西联通项目任意天节能报表", "deadline"=>null),
    array("cost"=>5, "real"=>6, "name_chn"=>"--  主项目session错误 部分地区和内网用户无法登陆", "deadline"=>null),
    array("cost"=>4, "real"=>4, "name_chn"=>"--  【运维】无合同分期过滤器", "deadline"=>null),
    array("cost"=>4, "real"=>4, "name_chn"=>"--  ESG_ID固化", "deadline"=>null),
    array("cost"=>4, "real"=>4, "name_chn"=>"--  【运维】电表环接反故障", "deadline"=>null),
    array("cost"=>4, "real"=>4, "name_chn"=>"--  服务器磁盘72%应急解决方案", "deadline"=>null),
    array("cost"=>6, "real"=>6, "name_chn"=>"--  分析给出分库方案", "deadline"=>null),
    array("cost"=>6, "real"=>6, "name_chn"=>"--  老数据分库数据库部分", "deadline"=>null),
    array("cost"=>8, "real"=>8, "name_chn"=>"--  老数据访问子系统", "deadline"=>null),
    array("cost"=>8, "real"=>8, "name_chn"=>"--  老数据接入节能系统", "deadline"=>null),
    array("cost"=>8, "real"=>8, "name_chn"=>"--  老数据接入节能系统测试", "deadline"=>null),
    array("cost"=>8, "real"=>8, "name_chn"=>"--  【运维】能耗较大检测", "deadline"=>null),
    array("cost"=>4, "real"=>4, "name_chn"=>"--  撰写部分服务器架构文档", "deadline"=>null)
);

$tasks = array_merge($tasks_old,$tasks_new);


$days = array();
for($i = 0;$i<100;$i++){
    $datetime = h_dt_add_day($config["start_day"],$i);
    $days[$datetime] = array(
        "datetime" => $datetime,
        "tomatos" => h_dt_is_saturday($datetime)?5:6,
        "is_rest" => h_dt_is_sunday($datetime),
        "do_list" => array(),
        "finish_list" => array()
    );
    //休假一天
    if($datetime == "20131115000000"){$days[$datetime]["tomatos"]=0;}
    //宜兴开会
    if($datetime == "20131120000000"){$days[$datetime]["tomatos"]=0;}
    //元旦
    if($datetime == "20140101000000"){$days[$datetime]["tomatos"]=0;}
    //南京开会
    if($datetime == "20140108000000"){$days[$datetime]["tomatos"]=0;}
    $days[$datetime]["left"] = $days[$datetime]["tomatos"];
}

main($config,$days,$tasks);

function main($config,$days,$tasks){

    $opts = getopt("l:f:");

    $curr_d = $config['start_day']; 

    foreach($tasks as $key => $task){
        $task['left_cost'] = $task['real'];
        while(1){
            $days[$curr_d]["do_list"][] = $task;
            if($task['left_cost'] > $days[$curr_d]['left']){
                $task['left_cost'] -= $days[$curr_d]['left'];
                $curr_d = h_next_day($days,$curr_d);
            }else if($task['left_cost'] == $days[$curr_d]['left']){
                $days[$curr_d]["finish_list"][] = $task;
                $days[$curr_d]['left'] -= $task['left_cost'];
                $curr_d = h_next_day($days,$curr_d);
                break;
            }else{
                $days[$curr_d]["finish_list"][] = $task;
                $days[$curr_d]['left'] -= $task['left_cost'];
                break;
            }
        }
    }

    //print
    $show_d = h_dt_start_time_of_day('-7 day'); 
    if(isset($opts['f']) && $opts['f'] = "all"){
        $show_d = $config['start_day']; 
    }
    $length = isset($opts['l'])?$opts['l']:14;

        foreach($days as $day){
            if(strtotime($day['datetime']) < strtotime($show_d)){
                continue;
            }
            if((--$length) <= 0){
                break;
            }
            if($day['is_rest']){
                echo "\n                  == 周日休息! == \n\n";
                continue;
            }
            echo h_dt_format($day['datetime'],"Y-m-d");
            echo " ";
            echo h_dt_week_name(h_dt_format($day['datetime'],"w"));
            echo " ";
            echo "[".$day['left']."]";
            echo "\n";
            foreach($day['finish_list'] as $task){
                echo $task['name_chn']." (".$task['cost']."/".$task['real'].")";
                echo "\n";
            }
            echo "\n";
        }
}


///////////// function ///////////////
    
function h_dt_week_name($d) {
    $a[0] = '周日';
    $a[1] = '周一';
    $a[2] = '周二';
    $a[3] = '周三';
    $a[4] = '周四';
    $a[5] = '周五';
    $a[6] = '周六';
    return $a[$d];
}
    
function h_dt_start_time_of_day($time_str) {
    $timestamp = strtotime($time_str);
    return (0 == $timestamp)?"":date("Ymd000000", $timestamp);
}
function h_dt_is_sunday($time_str){
    return date('w',strtotime($time_str)) == 0;
}

function h_dt_is_saturday($time_str){
    return date('w',strtotime($time_str)) == 6;
}

function h_dt_format($time_str,$format="YmdHis"){
    return date($format,strtotime($time_str));
}
function h_dt_add_day($time,$n=1){
    return date('YmdHis', strtotime($time)+86400*$n);
}
function h_dt_sub_day($time,$n=1){
    return date('YmdHis', strtotime($time)-86400*$n);
}

function h_next_day($days,$datetime){
    for($i = 0;$i<100;$i++){
        $datetime = h_dt_add_day($datetime);
        if($days[$datetime] && !$days[$datetime]['is_rest']){
            return $datetime;
        }
    }
    return null;
}





